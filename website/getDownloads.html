<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<script type="text/javascript">
/* <![CDATA[ */
function arrayContains(haystack, needle) {
	for (var i = 0; i < haystack.length; ++i) {
		if (haystack[i] == needle)
			return true;
	}
	return false;
}

function Download() {
	this.url = "";
	this.summary = "";
	this.labels = Array();
	this.size = "";
	this.type = "";
}

function getTwDownloads() {
	var xhr, response, rows, downloads, row, cols, labels, i, j, d, e;

	if (window.XMLHttpRequest) // Object of the current windows
		xhr = new XMLHttpRequest(); // Firefox, Safari, ...
	else if (window.ActiveXObject) // ActiveX version
		xhr = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer
	else
		return Array();

	xhr.open('GET', 'http://code.google.com/p/texworks/downloads/list?can=2&q=&sort=&colspec=Filename+Summary+Size+Type+Opsys', false);

	try {
		xhr.send(null);
	}
	catch(e) {
		// Something went wrong
		return Array();
	}

	response = xhr.responseText;

	response = response.substr(response.search(/(<table.+id="resultstable"[^>]*>)/) + RegExp.$1.length);
	response = response.substr(0, response.search(/<\/table>/));
	response = response.replace(/\s*<\/?tbody[^>]*>\s*/g, "");
	response = response.replace(/\r?\n/g, "");
	response = response.replace(/\s*<tr[^>]*>\s*/g, "");
	response = response.replace(/\s*<\/tr>\s*/g, "\n");

	// first row is header, last row is empty
	rows = response.split("\n");

	rows.shift();
	rows.pop();

	downloads = Array();
	for (i = 0; i < rows.length; ++i) {
		row = rows[i].replace(/\s*<td[^>]*>\s*/g, "");
		row = row.replace(/\s*<\/td>\s*/g, "\n");
		cols = row.split("\n");

		// cols: empty, url, summary+labels, size, type (=source), opsys, empty, ""
		if (cols.length != 8)
			continue;

		d = new Download();
		if (cols[1].match(/<a href="([^"]+)"[^>]*>/))
			d.url = RegExp.$1;
		if (cols[2].match(/<a[^>]*>\s*([^>]+)\s*<\/a>/))
			d.summary = RegExp.$1;
		if (cols[3].match(/<a[^>]*>\s*(.+)\s*<\/a>/))
			d.size = RegExp.$1;
		if (cols[4].match(/<a[^>]*>\s*(.+)\s*<\/a>/) && RegExp.$1 != "----")
			d.type = RegExp.$1.replace(/\s*$/, "");
		if (cols[5].match(/<a[^>]*>\s*(.+)\s*<\/a>/) && RegExp.$1 != "----")
			d.type = RegExp.$1.replace(/\s*$/, "");

		labels = cols[2].match(/<a[^>]+class="label"[^>]*>\s*([^>]+)\s*<\/a>/g);
		if (labels) {
			for (j = 0; j < labels.length; ++j)
				labels[j] = labels[j].replace(/<a[^>]+class="label"[^>]*>\s*([^>]+)\s*<\/a>/, "$1");
			d.labels = labels;
		}

		downloads[downloads.length] = d;
	}

	return downloads;
}
/* ]]> */
</script>
<style type="text/css">
body {
	margin: 0px;
	font-family: sans-serif;
}
ul.downloadlist {
	margin: 0px;
	margin-left: auto;
	list-style-type: none;
	padding: 0px;
}
ul.downloadlist li.stable {
	margin-bottom: 5px;
	background-color: #336600;
	color: #ccff99;
	padding: 1ex;
	text-align: center;
}
ul.downloadlist li a {
	color: inherit;
	text-decoration: none;
	font-weight: bold;
}
ul.downloadlist li.bleeding_edge {
	color: #996633;
	padding: 0ex 1ex;
	text-align: center;
	font-size: 75%;
}
</style>
</head>

<body>
<ul class="downloadlist">
<script>
/* <![CDATA[ */
downloads = getTwDownloads();

// These names should be the same as those used on the GC download page
myType = "Source";
if (navigator.appVersion.indexOf("Win") > -1)
	myType = "Windows";
if (navigator.appVersion.indexOf("Mac") > -1)
	myType = "OSX";

labels = new Object();
labels['Windows'] = "Get TeXworks for Windows";
labels['OSX'] = "Get TeXworks for Mac OS X";
labels['Source'] = "Get TeXworks source code";

items = new Array();
for (i = 0; i < downloads.length; ++i) {
	if (!arrayContains(downloads[i].labels, "Featured"))
		continue;
	html = '<li class="stable"><a href="' + downloads[i].url + '">' + labels[downloads[i].type] + '</a></li>';
	if (myType == downloads[i].type)
		items.unshift(html);
	else
		items.push(html);
}

if (downloads.length > 0)
	items.push('<li class="bleeding_edge"><a target="_blank" href="http://code.google.com/p/texworks/downloads/list">Bleeding edge versions</a> are also available</li>');
else
	items.push('<li class="stable"><a target="_blank" href="http://code.google.com/p/texworks/downloads/list">Get TeXworks from Google&nbsp;Code</li>');
document.writeln(items.join("\n"));
document.writeln();
/* ]]> */
</script>
</ul>
</body>
</html>
