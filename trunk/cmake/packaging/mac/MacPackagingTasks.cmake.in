# OS X packaging tasks

# This file is processed by CONFIGURE_FILE in ../CMakeLists.txt which inserts
# values for @VARIABLE@ declarations. This is done to import values for some
# variables that would otherwise be undefined when CPack is running.
SET(PROJECT_SOURCE_DIR @PROJECT_SOURCE_DIR@)
SET(PROJECT_NAME @PROJECT_NAME@)
SET(TeXworks_LIB_DIRS @TeXworks_LIB_DIRS@)

# This IF statement ensures that the following commands are executed only when
# CPack is running---i.e. when a user executes `make package` but not `make install`
IF ( ${CMAKE_INSTALL_PREFIX} MATCHES .*/_CPack_Packages/.* )

  # Download and install Poppler data
  # ---------------------------------
  IF ( NOT EXISTS ${PROJECT_SOURCE_DIR}/poppler-data-0.4.4.tar.gz )
    MESSAGE(STATUS "Downloading Poppler data files")
    FILE(DOWNLOAD "http://poppler.freedesktop.org/poppler-data-0.4.4.tar.gz"
      ${PROJECT_SOURCE_DIR}/poppler-data-0.4.4.tar.gz
      EXPECTED_MD5 f3a1afa9218386b50ffd262c00b35b31
      SHOW_PROGRESS
    )
  ENDIF ()

  IF ( NOT EXISTS ${PROJECT_SOURCE_DIR}/poppler-data-0.4.4 )
    EXECUTE_PROCESS(COMMAND tar xzf ${PROJECT_SOURCE_DIR}/poppler-data-0.4.4.tar.gz
      WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    )
  ENDIF ()

  FILE(INSTALL ${PROJECT_SOURCE_DIR}/poppler-data-0.4.4/
    DESTINATION ${CMAKE_INSTALL_PREFIX}/${PROJECT_NAME}.app/Contents/poppler-data
    PATTERN CMakeLists.txt EXCLUDE
    PATTERN Makefile EXCLUDE
  )

  # Copy all runtime dependencies and rewrite loader paths
  # ------------------------------------------------------

  # FIXUP_BUNDLE is a wonderful function provided by CMake's BundleUtilities
  # that examines an executable, finds all non-system libraries it depends
  # on, copies them into the .app and then re-writes the necessary loader
  # paths.
  INCLUDE(BundleUtilities)

  # Gather all Plugin libraries
  file(GLOB TeXworks_PLUGINS
    ${CMAKE_INSTALL_PREFIX}/${PROJECT_NAME}.app/Contents/PlugIns/*${CMAKE_SHARED_LIBRARY_SUFFIX})

  # If BU_CHMOD_BUNDLE_ITEMS is not set, install_name_tool will fail to
  # re-write some loader paths due to insufficiant permissions.
  SET(BU_CHMOD_BUNDLE_ITEMS ON)

  FIXUP_BUNDLE(${CMAKE_INSTALL_PREFIX}/${PROJECT_NAME}.app ${TeXworks_PLUGINS} ${TeXworks_LIB_DIRS})

ENDIF ()

